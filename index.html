<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Shopping List</title>
    <meta name="description" content="The Shopping List App">
    <meta name="author" content="Hannu JÃ¤rvinen">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://hannujarvinen.github.io/shoppinglist/css/styles.css">
    <link href="https://fonts.googleapis.com/css?family=Lobster" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="./js/bootbox.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase-database.js"></script>
    <script>
        var listid = null;
        var listname = null;
        var database = null;
        var initializing = true;
        $(document).on("domChanged", function() {
            putDB(listid);
            $("div.itemtext").off("click");
            $("div.item").off("swipeleft");
            $("div.item").off("swiperight");
            $("div.ctrl").off("click");
            $("div.itemtext").on("click", function() {
                var item = $(this);
                bootbox.prompt({
                    title: "Modify",
                    value: item.html(),
                    callback: function(result) {
                        if (result != null && result != "") {
                            item.html(result);
                        }
                    }
                });
            });
            $("div.item").on("swiperight", function() {
                var item = $(this);
                if (item.parent().attr("id") == "reservelist") {
                    removeItem(item);
                } else {
                    if (item.parent().attr("id") == "currentlist") {
                        moveToReserve(item);
                    }
                }
            });

            $("div.item").on("swipeleft", function() {
                var item = $(this);
                moveToList(item);
            });

            $("div.ctrl").on("click", function() {
                var item = $(this);
                if ($("span", this).hasClass("glyphicon-arrow-right")) {
                    moveToReserve($(this).parent());
                    return;
                }
                if ($("span", this).hasClass("glyphicon-arrow-left")) {
                    moveToList($(this).parent());
                    return;
                }
                if ($("span", this).hasClass("glyphicon-trash")) {
                    removeItem($(this).parent());
                    return;
                }
                if ($("span", this).hasClass("glyphicon-minus")) {
                    minusOne($(this).parent());
                    return;
                }
                if ($("span", this).hasClass("glyphicon-plus")) {
                    plusOne($(this).parent());
                    return;
                }
            });
        });

        function docInit() {
            initFB();
            init();
        };

        function initFB() {
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyBsmf8KwJu6dcr9r_4c6SWUKXM60s0zlMI",
                authDomain: "shoppinglist-b7c89.firebaseapp.com",
                databaseURL: "https://shoppinglist-b7c89.firebaseio.com",
                projectId: "shoppinglist-b7c89",
                storageBucket: "shoppinglist-b7c89.appspot.com",
                messagingSenderId: "282798514422"
            };
            firebase.initializeApp(config);
            // Get a reference to the database service
            database = firebase.database();
        }

        function plusOne(item) {
            var itemtext = item.children().first().html();
            var splitted = itemtext.split(" ");
            var num = splitted[0];
            if (!isNaN(num++)) {
                splitted[0] = num;
                item.children().first().html(splitted.join(" "));
                putDB(listid);
                return;
            } else {
                item.children().first().html("1 " + splitted.join(" "));
            }
        }

        function minusOne(item) {
            var itemtext = item.children().first().html();
            var splitted = itemtext.split(" ");
            if (!isNaN(splitted[0]--)) {
                if (splitted[0] == 0) {
                    splitted.shift();
                }
                item.children().first().html(splitted.join(" "));
                putDB(listid);
            }
        }

        function addNewItem(itemname) {
            if (itemname != null && itemname != "") {
                var newItem = createNewCurrentListItem(itemname);
                newItem.appendTo("#currentlist");
            }
            $("body").trigger("domChanged");
        }

        function createNewCurrentListItem(text) {
            var div = $('<div></div>');
            div.attr("class", "row item");
            div.append(newitemtextforcurrent(text));
            div.append(newminus());
            div.append(newplus());
            div.append(newarrowright());
            return div;
        }

        function createNewReserveListItem(text) {
            var div = $('<div></div>');
            div.attr("class", "row item");
            div.append(newitemtextforreserve(text));
            div.append(newarrowleft());
            div.append(newtrash());
            return div;
        }

        function moveToReserve(item) {
            item.remove();
            $("div.ctrl", item).remove();
            $("div.itemtext", item).attr("class", "col-xs-7 text-center itemtext");
            item.append(newarrowleft());
            item.append(newtrash());
            item.appendTo(document.getElementById("reservelist"));
            $("body").trigger("domChanged");
        }

        function moveToList(item) {
            item.remove();
            $("div.ctrl", item).remove();
            $("div.itemtext", item).attr("class", "col-xs-5 text-center itemtext");
            item.append(newminus());
            item.append(newplus());
            item.append(newarrowright());
            item.appendTo(document.getElementById("currentlist"));
            $("body").trigger("domChanged");
        }

        function addBtnPress() {
            bootbox.prompt("New item", function(result) {
                addNewItem(result);
            });
        }

        function moveAllToReserve() {
            var child = $("#currentlist").children().first();
            while ($("#currentlist").children().length != 0) {
                moveToReserve(child);
                child = $("#currentlist").children().first();
            }
            $("body").trigger("domChanged");
        }

        function removeItem(item) {
            bootbox.confirm("Delete '" + item.children().first().html() + "' permanently?", function(result) {
                if (result) {
                    item.remove();
                    $("body").trigger("domChanged");
                }
            });
        }

        function newminus() {
            var div = document.createElement("div");
            div.setAttribute("class", "col-xs-2 ctrl");
            var span = document.createElement("span");
            span.setAttribute("class", "glyphicon glyphicon-minus");
            span.setAttribute("aria-hidden", "true");
            div.appendChild(span);
            return div;
        }

        function newplus() {
            var div = document.createElement("div");
            div.setAttribute("class", "col-xs-2 ctrl");
            var span = document.createElement("span");
            span.setAttribute("class", "glyphicon glyphicon-plus");
            span.setAttribute("aria-hidden", "true");
            div.appendChild(span);
            return div;
        }

        function newarrowright() {
            var div = document.createElement("div");
            div.setAttribute("class", "col-xs-2 ctrl");
            var span = document.createElement("span");
            span.setAttribute("class", "glyphicon glyphicon-arrow-right");
            span.setAttribute("aria-hidden", "true");
            div.appendChild(span);
            return div;
        }

        function newarrowleft() {
            var div = document.createElement("div");
            div.setAttribute("class", "col-xs-2 ctrl");
            var span = document.createElement("span");
            span.setAttribute("class", "glyphicon glyphicon-arrow-left");
            span.setAttribute("aria-hidden", "true");
            div.appendChild(span);
            return div;
        }

        function newtrash() {
            var div = document.createElement("div");
            div.setAttribute("class", "col-xs-2 ctrl");
            var span = document.createElement("span");
            span.setAttribute("class", "glyphicon glyphicon-trash");
            span.setAttribute("aria-hidden", "true");
            div.appendChild(span);
            return div;
        }

        function newitemtextforcurrent(text) {
            var div = document.createElement("div");
            div.setAttribute("class", "col-xs-5 text-center itemtext");
            div.innerHTML = text;
            return div;
        }

        function newitemtextforreserve(text) {
            var div = document.createElement("div");
            div.setAttribute("class", "col-xs-7 text-center itemtext");
            div.innerHTML = text;
            return div;
        }

        function init() {
            // try to read listid from local storage
            listid = localStorage.listid;
            // if listid found
            if (!listid || listid == null || listid == "null") {
                // prompt if user wants to create a new list or use an existing shared list
                bootbox.confirm({
                    message: "Looks like this is your first time using the app with this device. Would you like to create a new list or use an existing shared list?",
                    buttons: {
                        confirm: {
                            label: 'Create a new list',
                            className: 'btn-success'
                        },
                        cancel: {
                            label: 'Use an existing shared list',
                            className: 'btn-success'
                        }
                    },
                    callback: function(result) {
                        if (result) {
                            // create new list
                            listid = token();
                            localStorage.listid = listid;
                            setupDBlistener(listid);
                            initializing = false;
                            putDB(listid);
                            $("body").trigger("domChanged");
                        } else {
                            // load existing shared list
                            bootbox.prompt("Please type the list identifier", function(result) {
                                localStorage.listid = result;
                                setupDBlistener(result);
                            });
                        }
                    }
                });
            } else {
                setupDBlistener(listid);
            }
        }

        function token() {
            return Math.random().toString(36).substr(2);
        }

        function setupDBlistener(listid) {
            if (listid != null && listid != "") {
                var dataRef = firebase.database().ref('lists/' + listid);
                dataRef.on('value', function(updated) {
                    updatelists(updated.val());
                });
            }
        }

        function updatelists(jsonstr) {
            // clear lists
            $("#currentlist").html("");
            $("#reservelist").html("");

            var json = jsonstr;
            listid = json.listid;
            listname = json.listname;
            if (listname == null || listname == "" || listname == "null" || typeof listname == "undefined") {
                listname = "unnamed";
            }
            $("#listname").html(listname);
            if (json.currentlist) {
                for (var i = 0; i < json.currentlist.length; i++) {
                    var newItem = createNewCurrentListItem(json.currentlist[i]);
                    newItem.appendTo("#currentlist");
                }
            }
            if (json.reservelist) {
                for (var i = 0; i < json.reservelist.length; i++) {
                    var newItem = createNewReserveListItem(json.reservelist[i]);
                    newItem.appendTo("#reservelist");
                }
            }
            initializing = false;
            $("body").trigger("domChanged");
        }

        function getDB(listid) {
            var jsonstr = '{"listid": "CDAsfSDGF", "currentlist": ["iKaffe", "Mysli"], "reservelist": ["Viili", "Maito", "Muroja"] }';
            return jsonstr;
        }

        function putDB(listid) {
            if (initializing) {
                return;
            }
            var data = new Object();
            data.listid = listid;
            data.listname = listname;
            var clistarray = [];
            var currentlist = $("#currentlist");
            for (var i = 0; i < currentlist.children().length; i++) {
                clistarray.push($("div.itemtext", currentlist.children()[i]).html());
            }
            data.currentlist = clistarray;
            var rlistarray = [];
            var reservelist = $("#reservelist");
            for (var i = 0; i < reservelist.children().length; i++) {
                rlistarray.push($("div.itemtext", reservelist.children()[i]).html());
            }
            data.reservelist = rlistarray;
            writeToFB(listid, data);
        }

        function writeToFB(listid, data) {
            if (listid != null && listid != "") {
                firebase.database().ref('lists/' + listid).set(data);
            } else {
                //notify.js that unable to write because no listid
            }
        }

        function share() {
            toClipboard(listid);
            bootbox.alert("Share your list with others by giving them this code: " + listid + " (code is copied automatically to clipboard on Android devices)");
        }

        function toClipboard(text) {
            var textField = document.createElement('textarea');
            textField.innerText = text;
            document.body.appendChild(textField);
            textField.select();
            document.execCommand('copy');
            $(textField).remove();
        }

        function changeList() {
            bootbox.confirm("Are you sure you want to stop using the current list?", function(result) {
                if (result) {
                    localStorage.listid = null;
                    location.reload();
                }
            });
        }

        function editlistname() {
            var nameitem = $("#listname");
            bootbox.prompt({
                title: "Modify list name",
                value: nameitem.html(),
                callback: function(result) {
                    if (result != null && result != "") {
                        nameitem.html(result);
                        listname = result;
                        putDB(listid);
                    }
                }
            });
        }

        function listmenu() {
            bootbox.alert("List menu is not yet implemented, sorry :(");
        }

        function toggleReserveList() {
            $("#reservelist").toggle();
            $("#visibilityToggleIcon").toggleClass("glyphicon-hand-right");
            $("#visibilityToggleIcon").toggleClass("glyphicon-hand-left");
        }

    </script>

    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
</head>

<body onload="docInit()">
    <div data-role="page" id="pageone">
        <div class="container-fluid">

            <div class="row">
                <div class="col-xs-12 container-fluid">
                    <button id="add" type="button" class="btn btn-info btn-md pull-right btn-add" aria-label="Left Align" onclick="addBtnPress()">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>
                    <button id="clear" type="button" class="btn btn-info btn-md pull-right" aria-label="Left Align" onclick="moveAllToReserve()">
                        Clear list
                    </button>
                    <button id="share" type="button" class="btn btn-info btn-md pull-left" aria-label="Left Align" onclick="share()">
                        Share list
                    </button>
                    <button id="change" type="button" class="btn btn-info btn-md pull-left" aria-label="Left Align" onclick="changeList()">
                        Change list
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12 sitename container-fluid">
                    Shopping list
                </div>
            </div>

            <div class="row listrow">
                <div class="col-xs-12 container-fluid">
                    <button id="listmenu" type="button" class="col-xs-2 btn btn-info btn-md pull-left" onclick="listmenu()">
                        <span class="glyphicon glyphicon-list"></span>
                    </button>
                    <button id="editlistname" type="button" class="col-xs-2 btn btn-info btn-md pull-left" onclick="editlistname()">
                        <span class="glyphicon glyphicon-edit"></span>
                    </button>
                    <div id="listname" class="listname col-xs-6">Loading list...
                    </div>
                    <button id="hideReserve" class="col-xs-2 btn btn-info btn-sm pull-right" onClick="toggleReserveList()">
                        <span id="visibilityToggleIcon" class="glyphicon glyphicon-hand-right" aria-hidden="true"></span>
                    </button>
                </div>
            </div>

            <div class="row ">
                <div id="currentlist" class="col-xs-6 container-fluid"></div>
                <div id="reservelist" class="col-xs-6 container-fluid"></div>
            </div>


        </div>
    </div>
</body>

</html>
